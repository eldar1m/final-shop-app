<div class="product-card">
  <div class="product-card__image-wrapper">
    {% if product %}
      <img src="{{ product.featured_image | img_url: 'master' }}" alt="{{ product.title }}">
    {% else %}
      <div class="product-placeholder"></div>
    {% endif %}
    {% unless product.available %}
      <div class="product-out-of-stock">Out of stock</div>
    {% endunless %}
  </div>
  <div class="product-card__info">
    <div class="product-vendor">{{ product.vendor | default: 'Vendor' }}</div>
    <div class="product-title">{{ product.title | default: 'Product Title' }}</div>
    <div class="product-price">
      {% if product.price %}
        {{ product.price | money_without_trailing_zeros }}
      {% else %}
        $0.00
      {% endif %}
    </div>
    {% if product.variants.size > 1 %}
      {% comment %} <a class="product-button" href="{{ product.url | default: '#' }}">View product</a> {% endcomment %}
      <div class="button-class">
        <button class="open-variant-overlay product-button" data-product-id="{{ product.id }}">Select Options</button>
        {% render 'variants-overlay', product: product %}
      </div>

    {% else %}
      <a class="product-button" href="{{ product.url | default: '#' }}">Quick add</a>
    {% endif %}
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Open overlay
    document.querySelectorAll('.open-variant-overlay').forEach((button) => {
      button.addEventListener('click', () => {
        const overlay = document.getElementById(`variant-overlay-${button.dataset.productId}`);
        if (overlay) overlay.classList.add('active');
      });
    });

    // Close overlay on icon or outside
    document.querySelectorAll('.variant-overlay').forEach((overlay) => {
      const closeBtn = overlay.querySelector('.close-variant-overlay');
      const content = overlay.querySelector('.variant-overlay-content');

      closeBtn.addEventListener('click', () => overlay.classList.remove('active'));

      overlay.addEventListener('click', (e) => {
        if (!content.contains(e.target)) {
          overlay.classList.remove('active');
        }
      });
    });

    // Add to cart + open cart drawer
    document.querySelectorAll('.variant-form').forEach((form) => {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData,
          headers: { Accept: 'application/json' },
        })
          .then((res) => res.json())
          .then((data) => {
            const overlay = form.closest('.variant-overlay');
            if (overlay) overlay.classList.remove('active');
            fetch('/cart.js')
              .then((res) => res.json())
              .then((cart) => {
                if (typeof renderCart === 'function') {
                  renderCart(cart);
                }
                document.getElementById('cart-drawer').classList.add('active');
                document.querySelector('.cart-drawer-overlay')?.classList.add('active');
              });
          });
      });
    });
  });
</script>
